name: Test Model Availability

on:
  workflow_dispatch:

jobs:
  test-models:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Test OpenAI Model
        id: test-openai
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o-mini
          prompt: |
            Hello, please respond with "Model test successful" if you are working.

      - name: Test Azure Model
        id: test-azure
        uses: actions/ai-inference@v1
        with:
          model: azure/gpt-4o-mini
          prompt: |
            Hello, please respond with "Azure model test successful" if you are working.

      - name: Test Basic Model
        id: test-basic
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          prompt: |
            Hello, please respond with "Basic model test successful" if you are working.

      - name: Output Results
        run: |
          echo "OpenAI Test: ${{ steps.test-openai.outputs.response }}"
          echo "Azure Test: ${{ steps.test-azure.outputs.response }}"
          echo "Basic Test: ${{ steps.test-basic.outputs.response }}"

          # Check which one worked
          if [[ "${{ steps.test-openai.outputs.response }}" == "Model test successful" ]]; then
            echo "✅ OpenAI model format works"
          elif [[ "${{ steps.test-azure.outputs.response }}" == "Azure model test successful" ]]; then
            echo "✅ Azure model format works"
          elif [[ "${{ steps.test-basic.outputs.response }}" == "Basic model test successful" ]]; then
            echo "✅ Basic model format works"
          else
            echo "❌ None of the model formats worked"
          fi

          # Save the working model format
          if [[ "${{ steps.test-openai.outputs.response }}" == "Model test successful" ]]; then
            echo "WORKING_MODEL=openai/gpt-4o-mini" >> $GITHUB_ENV
          elif [[ "${{ steps.test-azure.outputs.response }}" == "Azure model test successful" ]]; then
            echo "WORKING_MODEL=azure/gpt-4o-mini" >> $GITHUB_ENV
          elif [[ "${{ steps.test-basic.outputs.response }}" == "Basic model test successful" ]]; then
            echo "WORKING_MODEL=gpt-4o-mini" >> $GITHUB_ENV
          fi

      - name: Show Working Model
        run: |
          echo "The working model format is: ${{ env.WORKING_MODEL }}"

      - name: Test with Working Model
        if: env.WORKING_MODEL
        uses: actions/ai-inference@v1
        with:
          model: ${{ env.WORKING_MODEL }}
          prompt: |
            This is a final test with the working model format. Please respond with "Final test successful" if you are working.

      - name: Final Result
        if: env.WORKING_MODEL
        run: |
          echo "Final test response: ${{ steps.test-openai.outputs.response }}"

          if [[ "${{ steps.test-openai.outputs.response }}" == "Final test successful" ]]; then
            echo "✅ Final test successful with model ${{ env.WORKING_MODEL }}"
          else
            echo "❌ Final test failed"
          fi