name: SysCore CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BINARY_NAME: syscore
  DEPLOY_PATH: /opt/syscore
  SERVICE_NAME: syscore

jobs:
  # JOB 1: CI (Build & Test)
  # Runs on PRs and Pushes. Ensures code compiles before we even think about deploying.
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Build Release Binary
        run: |
          cd syscore
          cargo build --release

      - name: Generate Version
        id: version
        run: |
          # Create a unique version ID
          VERSION=$(date +'%Y-%m-%d')-$(git rev-parse --short HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Package Artifact
        run: |
          cd syscore/target/release
          # Compress the binary into a tarball
          tar -czf ../../../${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz ${{ env.BINARY_NAME }}
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: ${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz
          retention-days: 1

  # JOB 2: CD (Deploy)
  # Only runs on Pushes to Main. Requires manual approval if Environment is configured.
  deploy:
    name: Deploy to Production
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    # üõë This enables the "Human Intervention" / Manual Approval button
    environment: 
      name: production
      url: https://api.hackmist.tech/health

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
      
      # We skip the SSH key setup here because appleboy/ssh-action handles it internally
      
      - name: Upload to VM (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_SSH_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          source: "${{ env.BINARY_NAME }}-${{ needs.build.outputs.version }}.tar.gz"
          target: "/tmp/"

      - name: Activate and Restart (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_SSH_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script_stop: true
          envs: BINARY_NAME,DEPLOY_PATH,SERVICE_NAME
          script: |
            VERSION="${{ needs.build.outputs.version }}"
            ARTIFACT="/tmp/${BINARY_NAME}-${VERSION}.tar.gz"
            RELEASE_DIR="${DEPLOY_PATH}/releases/${VERSION}"
            CURRENT_LINK="${DEPLOY_PATH}/current"
            
            echo "üöÄ Starting Deployment for $VERSION..."
            
            # 1. Prepare Directory
            # We use sudo -n to ensure it fails fast if password is required (permissions check)
            if ! sudo -n true; then
                echo "‚ùå Error: sudo requires a password. Check /etc/sudoers.d/syscore-deploy"
                exit 1
            fi

            sudo mkdir -p "$RELEASE_DIR"
            sudo tar -xzf "$ARTIFACT" -C "$RELEASE_DIR"
            sudo chmod +x "$RELEASE_DIR/$BINARY_NAME"
            
            # 2. Capture Previous State (for Rollback)
            if [ -L "$CURRENT_LINK" ]; then
              PREV_LINK_TARGET=$(readlink "$CURRENT_LINK")
            else
              PREV_LINK_TARGET=""
            fi
            
            # 3. Atomic Link Switch
            echo "üîó Switching symlink..."
            sudo ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
            
            # 4. Restart Systemd
            echo "üîÑ Restarting Service..."
            if ! sudo systemctl restart $SERVICE_NAME; then
               echo "‚ùå Service failed to start."
               if [ -n "$PREV_LINK_TARGET" ]; then
                 echo "üîô Rolling back to previous version..."
                 sudo ln -sfn "$PREV_LINK_TARGET" "$CURRENT_LINK"
                 sudo systemctl restart $SERVICE_NAME
               fi
               exit 1
            fi
            
            # 5. Health Check
            echo "üíì Checking Health..."
            sleep 3
            if ! curl -s --fail http://127.0.0.1:3001/health; then
               echo "‚ùå Health check failed."
               if [ -n "$PREV_LINK_TARGET" ]; then
                 echo "üîô Rolling back due to health failure..."
                 sudo ln -sfn "$PREV_LINK_TARGET" "$CURRENT_LINK"
                 sudo systemctl restart $SERVICE_NAME
               fi
               exit 1
            fi
            
            echo "‚úÖ Deployment Complete: $VERSION"
            rm "$ARTIFACT"
