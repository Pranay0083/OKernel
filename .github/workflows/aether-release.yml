name: Aether Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0)'
        required: false # Optional if triggered by tag, or we can fallback
        type: string
      description:
        description: 'Release Description'
        required: false
        type: string
      changelog:
        description: 'Changelog'
        required: false
        type: string
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      # Determine Version
      - name: Set Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
            echo "DESCRIPTION=${{ inputs.description }}" >> $GITHUB_ENV
            echo "CHANGELOG=${{ inputs.changelog }}" >> $GITHUB_ENV
          else
            # Extract from tag v0.3.0 -> 0.3.0
            TAG_NAME=${{ github.ref_name }}
            VERSION=${TAG_NAME#v}
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "DESCRIPTION=Automated Release $VERSION" >> $GITHUB_ENV
            # Get commit message as changelog or leave empty
            echo "CHANGELOG=${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          fi

      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install Dependencies
        run: |
          brew install create-dmg

      - name: Build Aether
        working-directory: apps/aether
        run: |
          chmod +x build_release.sh
          ./build_release.sh

      - name: Publish to Syscore
        run: |
          DMG_PATH="apps/aether/Aether_Installer.dmg"
          
          if [ ! -f "$DMG_PATH" ]; then
            echo "Error: DMG file not found at $DMG_PATH"
            exit 1
          fi

          echo "Publishing version $VERSION..."
          
          # Upload via curl
          echo "Uploading to API..."
          curl --fail -v -X POST \
            -H "Authorization: Bearer ${{ secrets.AETHER_UPLOAD_KEY }}" \
            -F "file=@$DMG_PATH" \
            -F "version=$VERSION" \
            -F "description=$DESCRIPTION" \
            -F "changelog=$CHANGELOG" \
            "https://api.hackmist.tech/api/v1/aether"
