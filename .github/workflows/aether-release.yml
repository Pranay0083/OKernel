name: Aether Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0)'
        required: true
        type: string
      description:
        description: 'Release Description'
        required: false
        type: string
      changelog:
        description: 'Changelog'
        required: false
        type: string

jobs:
  build-and-publish:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install Dependencies
        run: |
          brew install create-dmg

      - name: Build Aether
        working-directory: apps/aether
        run: |
          chmod +x build_release.sh
          ./build_release.sh

      - name: Publish to Syscore
        run: |
          DMG_PATH="apps/aether/Aether_Installer.dmg"
          
          if [ ! -f "$DMG_PATH" ]; then
            echo "Error: DMG file not found at $DMG_PATH"
            exit 1
          fi

          echo "Publishing version ${{ inputs.version }}..."
          
          # Upload via curl
          # Using specific endpoint logic for file upload with metadata
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.AETHER_UPLOAD_KEY }}" \
            -F "file=@$DMG_PATH" \
            -F "version=${{ inputs.version }}" \
            -F "description=${{ inputs.description }}" \
            -F "changelog=${{ inputs.changelog }}" \
            https://api.hackmist.tech/api/v1/aether)

          http_code=$(tail -n1 <<< "$response")  # Correctly capture extraction of http_code logic if response contains body
          # Simplified curl for clearer logic in CI:
          
          curl --fail -v -X POST \
            -H "Authorization: Bearer ${{ secrets.AETHER_UPLOAD_KEY }}" \
            -F "file=@$DMG_PATH" \
            -F "version=${{ inputs.version }}" \
            -F "description=${{ inputs.description }}" \
            -F "changelog=${{ inputs.changelog }}" \
            https://api.hackmist.tech/api/v1/aether
