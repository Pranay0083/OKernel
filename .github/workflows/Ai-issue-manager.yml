name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o-mini
          prompt: |
            You are an advanced GitHub issue triage AI. Your goal is to deeply analyze the issue content to categorize it accurately and provide helpful initial triage.

            Analyze the following issue:
            Title: "${{ github.event.issue.title }}"
            Body: "${{ github.event.issue.body }}"

            Tasks:
            1. **Analyze**: Understand the core intent. Is it a bug report, a feature proposal, a question, or a documentation issue?
            2. **Label**: Assign relevant labels. Use 'bug' for errors, 'feature-request' for new ideas, 'question' for inquiries, 'documentation' for docs. Add 'security' if it looks sensitive. Estimate severity: 'low', 'medium', 'high', 'critical'.
            3. **Summarize**: Write a concise, technical summary of the issue.
            4. **Solution/Advice**: Suggest a potential path forward, specific file checks, or immediate troubleshooting steps.
            5. **Checklist**: specific actionable steps for the maintainer or contributor.

            Respond ONLY with valid JSON matching this schema:
            {
              "summary": "concise technical summary",
              "severity": "low|medium|high|critical",
              "labels": ["label1", "label2"],
              "solution": "technical advice or potential fix",
              "questions": ["clarifying question 1 (if needed)"],
              "checklist": ["action item 1", "action item 2"]
            }

      - name: Build AI comment
        run: |
          set -e

          echo "$RESPONSE" > response.json

          SUMMARY=$(jq -r '.summary // "No summary provided."' response.json)
          SEVERITY=$(jq -r '.severity // "low"' response.json)
          SOLUTION=$(jq -r '.solution // "No solution proposed."' response.json)

          QUESTIONS=$(jq -r '.questions[]?' response.json | sed 's/^/- /')
          CHECKLIST=$(jq -r '.checklist[]?' response.json | sed 's/^/- [ ] /')

          [ -z "$QUESTIONS" ] && QUESTIONS="- No clarification needed."
          [ -z "$CHECKLIST" ] && CHECKLIST="- [ ] No checklist provided."

          printf "### AI Issue Triage\n\n" > comment.md
          printf "**Summary**\n%s\n\n" "$SUMMARY" >> comment.md
          printf "**Severity**\n\`%s\`\n\n" "$SEVERITY" >> comment.md
          printf "**Potential Solution**\n%s\n\n" "$SOLUTION" >> comment.md
          printf "**Questions**\n%s\n\n" "$QUESTIONS" >> comment.md
          printf "**Checklist**\n%s\n" "$CHECKLIST" >> comment.md
        env:
          RESPONSE: ${{ steps.inference.outputs.response }}

      - name: Post AI comment
        run: |
          gh issue comment "$ISSUE_NUMBER" --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      - name: Create and assign labels
        run: |
          set -e

          echo "$RESPONSE" > response.json

          for label in $(jq -r '.labels[]?' response.json); do
            echo "Ensuring label: $label"

            gh label create "$label" \
              --color "ededed" \
              --description "Auto-created by AI triage workflow" \
              --force || true

            gh issue edit "$ISSUE_NUMBER" --add-label "$label"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RESPONSE: ${{ steps.inference.outputs.response }}
