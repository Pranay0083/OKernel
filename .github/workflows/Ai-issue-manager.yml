name: AI Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          prompt: |
            You are an expert GitHub issue triage assistant.

            Respond ONLY with valid JSON.

            Tasks:
            - Determine if the issue is valid
            - Suggest a solution
            - Ask clarifying questions if needed
            - Provide a checklist
            - Assign labels

            Allowed labels:
            bug, ui, feature-request, low, medium, high, needs-info

            Issue:
            Title: "${{ github.event.issue.title }}"
            Body: "${{ github.event.issue.body }}"

            JSON format:
            {
              "summary": "one paragraph summary",
              "severity": "low | medium | high",
              "labels": ["bug", "ui"],
              "questions": ["question1"],
              "solution": "suggested solution",
              "checklist": ["step1", "step2"]
            }

      - name: Build AI comment
        run: |
          set -e

          echo "$RESPONSE" > response.json

          SUMMARY=$(jq -r '.summary // "No summary provided."' response.json)
          SEVERITY=$(jq -r '.severity // "low"' response.json)
          SOLUTION=$(jq -r '.solution // "No solution proposed."' response.json)

          QUESTIONS=$(jq -r '.questions[]?' response.json | sed 's/^/- /')
          CHECKLIST=$(jq -r '.checklist[]?' response.json | sed 's/^/- [ ] /')

          [ -z "$QUESTIONS" ] && QUESTIONS="- No clarification needed."
          [ -z "$CHECKLIST" ] && CHECKLIST="- [ ] No checklist provided."

          printf "### AI Issue Triage\n\n" > comment.md
          printf "**Summary**\n%s\n\n" "$SUMMARY" >> comment.md
          printf "**Severity**\n\`%s\`\n\n" "$SEVERITY" >> comment.md
          printf "**Potential Solution**\n%s\n\n" "$SOLUTION" >> comment.md
          printf "**Questions**\n%s\n\n" "$QUESTIONS" >> comment.md
          printf "**Checklist**\n%s\n" "$CHECKLIST" >> comment.md
        env:
          RESPONSE: ${{ steps.inference.outputs.response }}

      - name: Post AI comment
        run: |
          gh issue comment "$ISSUE_NUMBER" --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      - name: Create and assign labels
        run: |
          set -e

          echo "$RESPONSE" > response.json

          for label in $(jq -r '.labels[]?' response.json); do
            echo "Ensuring label: $label"

            gh label create "$label" \
              --color "ededed" \
              --description "Auto-created by AI triage workflow" \
              --force || true

            gh issue edit "$ISSUE_NUMBER" --add-label "$label"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RESPONSE: ${{ steps.inference.outputs.response }}
